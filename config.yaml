# ================================================================================
# DolphinScheduler 3.2.0 EC2 集群部署配置文件
# 使用外部 RDS MySQL、Zookeeper 和 S3 存储
# ================================================================================

# ================================================================================
# 【项目信息】用于资源标签管理
# ================================================================================
project:
  name: dolphinscheduler-prod  # 项目名称，用于 AWS 资源标签

# ================================================================================
# 【必填配置】以下配置必须填写
# ================================================================================
database:
  type: mysql
  host: tx-db.cbore8wpy3mc.us-east-2.rds.amazonaws.com  # 必填：RDS 端点地址
  port: 3306
  username: dsadmin  # 必填：数据库用户名
  password: ds123456  # 必填：数据库密码
  database: dolphinscheduler  # 必填：数据库名称
  params: useUnicode=true&characterEncoding=UTF-8&useSSL=false

# ===== 注册中心配置 (Zookeeper) - 必填 =====
registry:
  type: zookeeper
  # 必填：Zookeeper 集群地址
  servers:
    - 172.31.6.163:2181
  namespace: dolphinscheduler
  connection_timeout: 30000
  session_timeout: 60000
  retry:
    base_sleep_time: 1000
    max_sleep_time: 3000
    max_retries: 5

# ===== 资源存储配置 (LOCAL) - 必填 =====
# 用于 DolphinScheduler 资源中心存储上传的文件
storage:
  type: LOCAL
  # LOCAL 存储配置 - 文件存储在各节点本地磁盘
  # 注意：仅适合开发/测试环境，生产环境建议使用 HDFS 或 S3
  local:
    base_dir: /tmp/dolphinscheduler  # 本地存储路径
  
  # ===== HDFS 存储配置 - 备用（如需切换到 HDFS）=====
  # 如果要使用 HDFS 作为资源存储，修改 type: HDFS 并取消下面的注释
  # type: HDFS
  # hdfs:
  #   namenode_host: 172.31.6.163  # HDFS NameNode 主机地址（EMR 主节点）
  #   namenode_port: 8020  # HDFS NameNode 端口（默认 8020）
  #   upload_path: /dolphinscheduler  # HDFS 上的资源存储路径
  #   user: hadoop  # HDFS 用户名（通常是 hadoop）
  
  # ===== S3 存储配置 - 备用（如需使用 S3 作为资源存储）=====
  # 如果要使用 S3 作为资源存储，修改 type: S3 并取消下面的注释
  # type: S3
  # bucket: tx-mageline-eks  # S3 bucket 名称
  # region: us-east-2  # S3 区域
  # upload_path: /dolphinscheduler  # S3 上的资源存储路径
  # use_iam_role: true  # 推荐使用 IAM Role
  # access_key_id: ""
  # secret_access_key: ""
  # endpoint: https://s3.us-east-2.amazonaws.com

# ===== 部署包分发配置 (S3) - 可选 =====
# 用于加速 DolphinScheduler 部署包的下载和分发
# 如果不配置，将直接从互联网下载（较慢）
package_distribution:
  enabled: true  # 是否启用 S3 包分发
  s3:
    bucket: tx-mageline-eks  # S3 bucket 名称
    region: us-east-2  # S3 区域
    key: dolphinischeduler-3.2.0/apache-dolphinscheduler-3.2.0-bin.tar.gz  # S3 中的包路径
    use_iam_role: true  # 推荐使用 IAM Role
    # access_key_id: ""  # 仅当 use_iam_role=false 时需要
    # secret_access_key: ""  # 仅当 use_iam_role=false 时需要

# ===== AWS 基础配置 - 必填 =====
aws:
  region: us-east-2  # 必填：AWS 区域
  vpc_id: vpc-0c9a0d81e8f5ca012 # 必填：VPC ID
  # 必填：子网配置（支持跨可用区高可用部署）
  # 建议配置 2-3 个不同可用区的子网
  subnets:
    - subnet_id: subnet-027700489b00e3c22  # 可用区 A 的子网
      availability_zone: us-east-2a
    - subnet_id: subnet-07589363bd3782beb  # 可用区 B 的子网
      availability_zone: us-east-2b
    - subnet_id: subnet-0f0fee34cbe94fe38  # 可用区 C 的子网（可选）
      availability_zone: us-east-2c
  key_name: ec2-ohio  # 必填：SSH 密钥对名称
  iam_instance_profile: AdminRole  # 必填（如果 use_iam_role=true）
  # 必填：安全组配置
  security_groups:
    master: sg-0b4d077af6fa8c4ee
    worker: sg-0b4d077af6fa8c4ee
    api: sg-0b4d077af6fa8c4ee
    alert: sg-0b4d077af6fa8c4ee

# ===== 集群节点配置 - 必填 =====
cluster:
  # Master 节点配置
  master:
    count: 2  # 必填：节点数量（建议 2-3 个）
    instance_type: m7i.xlarge  # 必填：实例类型
    # 节点列表（创建集群时自动生成，无需手动填写）
    nodes: []

  # Worker 节点配置
  worker:
    count: 3  # 必填：节点数量（根据任务量调整）
    instance_type: m7i.xlarge  # 必填：实例类型
    # 节点列表（创建集群时自动生成，无需手动填写）
    nodes: []

  # API 节点配置
  api:
    count: 2  # 必填：节点数量（建议 2 个以上）
    instance_type: m7i.large  # 必填：实例类型
    # 节点列表（创建集群时自动生成，无需手动填写）
    nodes: []

  # Alert 节点配置
  alert:
    count: 1  # 必填：节点数量（通常 1 个即可）
    instance_type: m7i.large  # 必填：实例类型
    # 节点列表（创建集群时自动生成，无需手动填写）
    nodes: []

# ===== 部署配置 - 必填 =====
deployment:
  user: dolphinscheduler  # 必填：部署用户（需要 sudo 权限）
  install_path: /opt/dolphinscheduler  # 必填：安装路径
  version: 3.2.0  # 必填：DolphinScheduler 版本（推荐使用 3.2.0）
  skip_system_update: true  # 跳过系统更新以加快部署（推荐）
  parallel_init_workers: 10  # 并行初始化的最大线程数
  download_on_remote: true  # 在目标节点直接下载（推荐，更快）

# ================================================================================
# 【可选配置】以下配置有默认值，可根据需要调整
# ================================================================================

# ===== EC2 实例详细配置（可选）=====
ec2_advanced:
  master:
    root_volume_size: 200  # 根卷大小（GB）
    root_volume_type: gp3  # 根卷类型
    tags:
      Name: dolphinscheduler-master
      Environment: production
      Component: master

  worker:
    root_volume_size: 200
    root_volume_type: gp3
    tags:
      Name: dolphinscheduler-worker
      Environment: production
      Component: worker

  api:
    root_volume_size: 200
    root_volume_type: gp3
    tags:
      Name: dolphinscheduler-api
      Environment: production
      Component: api

  alert:
    root_volume_size: 200  # 最小 30GB（AMI 快照要求）
    root_volume_type: gp3
    tags:
      Name: dolphinscheduler-alert
      Environment: production
      Component: alert

# ===== 服务配置（可选）=====
service_config:
  master:
    listen_port: 5678
    exec_threads: 100
    dispatch_task_number: 3
    host_selector: LowerWeight
    heartbeat_interval: 10
    task_commit_retry_times: 5
    task_commit_interval: 1
    max_cpu_load_avg: -1
    reserved_memory: 0.3

  worker:
    listen_port: 1234
    exec_threads: 100
    heartbeat_interval: 10
    max_cpu_load_avg: -1
    reserved_memory: 0.3
    exec_path: /tmp/dolphinscheduler/exec

  api:
    port: 12345
    session_timeout: 7200
    context_path: /dolphinscheduler
    # 负载均衡器配置（可选）
    load_balancer:
      enabled: true
      type: application  # application 或 network
      scheme: internet-facing  # internet-facing 或 internal
      # ALB 子网（必须是公有子网，且跨多个可用区）
      subnets:
        - subnet-07589363bd3782beb  # 可用区 A 的公有子网
        - subnet-027700489b00e3c22  # 可用区 B 的公有子网
      listener_port: 80
      health_check:
        path: /dolphinscheduler/actuator/health
        interval: 30
        timeout: 5
        healthy_threshold: 2
        unhealthy_threshold: 3

  alert:
    port: 50052
    wait_timeout: 5000

# ===== JVM 配置（可选）=====
jvm:
  master:
    xms: 4g
    xmx: 4g
    xmn: 2g
    gc: G1GC
    extra_opts: "-XX:+UseG1GC -XX:+PrintGCDetails -Xloggc:logs/gc.log"

  worker:
    xms: 8g
    xmx: 8g
    xmn: 4g
    gc: G1GC
    extra_opts: "-XX:+UseG1GC -XX:+PrintGCDetails -Xloggc:logs/gc.log"

  api:
    xms: 2g
    xmx: 2g
    xmn: 1g
    gc: G1GC
    extra_opts: "-XX:+UseG1GC -XX:+PrintGCDetails -Xloggc:logs/gc.log"

  alert:
    xms: 1g
    xmx: 1g
    xmn: 512m
    gc: G1GC
    extra_opts: "-XX:+UseG1GC -XX:+PrintGCDetails -Xloggc:logs/gc.log"

# ===== 其他配置（可选）=====
advanced:
  # 包分发配置 - 优先级从高到低
  # S3 预上传包（最快，推荐）
  s3_package:
    enabled: true
    bucket: tx-mageline-eks
    key: dolphinischeduler-3.2.0/apache-dolphinscheduler-3.2.0-bin.tar.gz
    region: us-east-2
  
  # 下载地址 - DolphinScheduler 3.2.0（备用）
  # Apache 官方归档（推荐）
  download_url: https://archive.apache.org/dist/dolphinscheduler/3.2.0/apache-dolphinscheduler-3.2.0-bin.tar.gz
  # 清华镜像（备选，中国访问快）
  # download_url: https://mirrors.tuna.tsinghua.edu.cn/apache/dolphinscheduler/3.2.0/apache-dolphinscheduler-3.2.0-bin.tar.gz
  # 华为云镜像（备选）
  # download_url: https://repo.huaweicloud.com/apache/dolphinscheduler/3.2.0/apache-dolphinscheduler-3.2.0-bin.tar.gz

  # 日志配置
  logging:
    level: INFO
    retention_days: 7
    path: logs

  # 安全配置
  security:
    https_enabled: false
    ssl_cert_path: ""
    ssl_key_path: ""

  # 监控配置
  monitoring:
    prometheus_enabled: false
    prometheus_port: 9090

# ================================================================================
# 配置说明
# ================================================================================
# 1. 【必填配置】必须填写，否则部署会失败
# 2. 【可选配置】有默认值，可根据实际需求调整
# 3. 密码和密钥建议使用环境变量，不要硬编码
# 4. 推荐使用 IAM Role 访问 S3，更安全且无需管理密钥
# 5. 确保所有节点网络互通，安全组规则正确配置
# 6. 部署前需要在所有节点创建部署用户并配置 SSH 免密登录
# 7. RDS MySQL 需要提前创建数据库和用户
#
# 【高可用架构建议】
# 8. 配置 2-3 个不同可用区的子网，实现跨可用区部署
# 9. Master 节点建议部署在不同可用区（至少 2 个）
# 10. Worker 节点建议均匀分布在各个可用区
# 11. API 节点建议部署在不同可用区，配合 ALB 实现高可用
# 12. RDS MySQL 建议启用 Multi-AZ 部署
# 13. ALB 必须配置在公有子网，且跨多个可用区
