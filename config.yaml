# ================================================================================
# DolphinScheduler 3.2.2 EC2 集群部署配置文件
# 使用外部 RDS MySQL、EMR Zookeeper 和 S3 存储
# ================================================================================

# ================================================================================
# 【项目信息】用于资源标签管理
# ================================================================================
project:
  name: dolphinscheduler-prod  # 项目名称，用于 AWS 资源标签

# ================================================================================
# 【必填配置】以下配置必须填写
# ================================================================================
database:
  type: mysql
  host: tx-db.cbore8wpy3mc.us-east-2.rds.amazonaws.com  # 必填：RDS 端点地址
  port: 3306
  username: dsadmin  # 必填：数据库用户名
  password: ds123456  # 必填：数据库密码
  database: dolphinscheduler  # 必填：数据库名称
  params: useUnicode=true&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true

# ===== 注册中心配置 (Zookeeper) - 必填 =====
# 使用外部 EMR 集群提供的 Zookeeper 服务
registry:
  type: zookeeper
  # 必填：Zookeeper 集群地址（EMR Master 节点）
  servers:
    - ec2-3-142-173-229.us-east-2.compute.amazonaws.com:2181
  namespace: dolphinscheduler
  connection_timeout: 9000   # 9s
  session_timeout: 30000     # 30s
  block_until_connected: 600  # 600ms
  retry:
    base_sleep_time: 60      # 60ms
    max_sleep_time: 300      # 300ms
    max_retries: 5

# ===== 资源存储配置 (S3) - 必填 =====
# 用于 DolphinScheduler 资源中心存储上传的文件
storage:
  type: S3
  # ===== S3 存储配置 =====
  s3:
    bucket: tx-mageline-eks  # S3 bucket 名称
    region: us-east-2  # S3 区域
    upload_path: /dolphinscheduler  # S3 上的资源存储路径
    endpoint: https://s3.us-east-2.amazonaws.com
    # 认证方式：使用 AK/SK（IAM Role 在 DolphinScheduler 3.2.2 中有已知 bug）
    use_iam_role: false
    # 必填：S3 访问密钥（注意：DolphinScheduler 3.2.2 的 IAM Role 支持有问题，必须使用 AK/SK）
    access_key_id: "AKIA..."  # 必填：AWS Access Key ID
    secret_access_key: "..."  # 必填：AWS Secret Access Key
  
  # ===== Azure 占位配置（必须配置，否则 CloudServiceImpl 初始化会失败）=====
  azure:
    client_id: placeholder
    client_secret: placeholder
    sub_id: placeholder
    tenant_id: placeholder

# ===== EMR 集群配置 - 用于 Zookeeper =====
emr:
  master_host: 172.31.6.163  # EMR 主节点地址（Zookeeper 所在节点）
  master_user: hadoop  # EMR 主节点 SSH 用户名
  master_key_file: /home/ec2-user/work/dolphinscheduler-ec2-on-aws/ec2-ohio.pem

# ===== 部署包分发配置 (S3) - 可选 =====
# 用于加速 DolphinScheduler 部署包的下载和分发
package_distribution:
  enabled: false  # 建议禁用，直接从互联网下载更可靠
  s3:
    bucket: tx-mageline-eks  # S3 bucket 名称
    region: us-east-2  # S3 区域
    key: dolphinscheduler-3.2.2/apache-dolphinscheduler-3.2.2-bin.tar.gz  # S3 中的包路径
    use_iam_role: false  # 不使用 IAM Role（有 bug）

# ===== AWS 基础配置 - 必填 =====
aws:
  region: us-east-2  # 必填：AWS 区域
  vpc_id: vpc-0c9a0d81e8f5ca012 # 必填：VPC ID
  # 必填：子网配置（支持跨可用区高可用部署）
  subnets:
    - subnet_id: subnet-027700489b00e3c22
      availability_zone: us-east-2a
    - subnet_id: subnet-07589363bd3782beb
      availability_zone: us-east-2b
    - subnet_id: subnet-0f0fee34cbe94fe38
      availability_zone: us-east-2c
  key_name: ec2-ohio  # 必填：SSH 密钥对名称
  iam_instance_profile: AdminRole  # 可选：IAM 实例配置文件（用于 EC2 管理，不影响 DolphinScheduler S3 访问）
  # 必填：安全组配置
  security_groups:
    master: sg-0b4d077af6fa8c4ee
    worker: sg-0b4d077af6fa8c4ee
    api: sg-0b4d077af6fa8c4ee
    alert: sg-0b4d077af6fa8c4ee

# ===== 集群节点配置 - 必填 =====
# selector: 相同 selector 值的组件部署在同一台虚拟机上
# 例如: master.selector=1, worker.selector=1, api.selector=1 表示这三个组件部署在同一台机器
cluster:
  # Master 节点配置
  master:
    count: 2  # 节点数量
    instance_type: t3.large
    nodes:
      - selector: 1  # 与 selector=1 的其他组件部署在同一台机器
        availability_zone: us-east-2a
      - selector: 2
        availability_zone: us-east-2b

  # Worker 节点配置
  worker:
    count: 3  # 节点数量（根据任务量调整）
    instance_type: t3.xlarge
    nodes:
      - selector: 1  # 与 selector=1 的 master 部署在同一台机器
        availability_zone: us-east-2a
        groups:
          - default
      - selector: 2
        availability_zone: us-east-2b
        groups:
          - default
      - selector: 3
        availability_zone: us-east-2c
        groups:
          - default

  # API 节点配置（高可用：部署在两个节点）
  api:
    count: 2  # 节点数量（高可用）
    instance_type: t3.large
    nodes:
      - selector: 1  # 与 selector=1 的 master/worker 部署在同一台机器
        availability_zone: us-east-2a
      - selector: 2  # 与 selector=2 的 master/worker 部署在同一台机器
        availability_zone: us-east-2b

  # Alert 节点配置
  alert:
    count: 1  # 节点数量（通常 1 个即可）
    instance_type: t3.large
    nodes:
      - selector: 1  # 与 selector=1 的其他组件部署在同一台机器
        availability_zone: us-east-2a

# ===== 部署配置 - 必填 =====
deployment:
  user: dolphinscheduler  # 部署用户（需要 sudo 权限）
  install_path: /opt/dolphinscheduler  # 安装路径
  version: 3.2.2  # DolphinScheduler 版本
  skip_system_update: true  # 跳过系统更新以加快部署
  parallel_init_workers: 10  # 并行初始化的最大线程数
  download_on_remote: true  # 在目标节点直接下载
  # Java 版本配置（3.2.2 推荐 Java 11）
  java_home: /usr/lib/jvm/java-11-openjdk-amd64

# ================================================================================
# 【可选配置】以下配置有默认值，可根据需要调整
# ================================================================================

# ===== EC2 实例详细配置（可选）=====
ec2_advanced:
  master:
    root_volume_size: 100
    root_volume_type: gp3
    tags:
      Name: dolphinscheduler-master
      Environment: production
      Component: master

  worker:
    root_volume_size: 100
    root_volume_type: gp3
    tags:
      Name: dolphinscheduler-worker
      Environment: production
      Component: worker

  api:
    root_volume_size: 60
    root_volume_type: gp3
    tags:
      Name: dolphinscheduler-api
      Environment: production
      Component: api

  alert:
    root_volume_size: 100
    root_volume_type: gp3
    tags:
      Name: dolphinscheduler-alert
      Environment: production
      Component: alert

# ===== 服务配置（可选）=====
service_config:
  master:
    listen_port: 5679  # 3.2.2 默认端口
    exec_threads: 100
    dispatch_task_number: 3
    host_selector: LowerWeight
    heartbeat_interval: 10
    task_commit_retry_times: 5
    task_commit_interval: 1
    max_cpu_load_avg: -1
    reserved_memory: 0.3

  worker:
    listen_port: 1235  # 3.2.2 默认端口
    exec_threads: 100
    heartbeat_interval: 10
    max_cpu_load_avg: -1
    reserved_memory: 0.3
    exec_path: /tmp/dolphinscheduler/exec

  api:
    port: 12345
    session_timeout: 7200
    context_path: /dolphinscheduler
    load_balancer:
      enabled: true
      type: application
      scheme: internet-facing
      subnets:
        - subnet-07589363bd3782beb
        - subnet-027700489b00e3c22
      listener_port: 80
      health_check:
        path: /dolphinscheduler/actuator/health
        interval: 30
        timeout: 5
        healthy_threshold: 2
        unhealthy_threshold: 3

  alert:
    port: 50052
    wait_timeout: 5000

# ===== JVM 配置（可选）=====
jvm:
  master:
    xms: 4g
    xmx: 4g
    xmn: 2g
    gc: G1GC
    extra_opts: "-XX:+UseG1GC -XX:+PrintGCDetails -Xloggc:logs/gc.log"

  worker:
    xms: 8g
    xmx: 8g
    xmn: 4g
    gc: G1GC
    extra_opts: "-XX:+UseG1GC -XX:+PrintGCDetails -Xloggc:logs/gc.log"

  api:
    xms: 2g
    xmx: 2g
    xmn: 1g
    gc: G1GC
    extra_opts: "-XX:+UseG1GC -XX:+PrintGCDetails -Xloggc:logs/gc.log"

  alert:
    xms: 1g
    xmx: 1g
    xmn: 512m
    gc: G1GC
    extra_opts: "-XX:+UseG1GC -XX:+PrintGCDetails -Xloggc:logs/gc.log"

# ===== 其他配置（可选）=====
advanced:
  # S3 预上传包（最快，推荐）
  s3_package:
    enabled: true
    bucket: tx-mageline-eks
    key: dolphinscheduler-3.2.2/apache-dolphinscheduler-3.2.2-bin.tar.gz
    region: us-east-2
  
  # 下载地址 - DolphinScheduler 3.2.2（备用）
  download_url: https://archive.apache.org/dist/dolphinscheduler/3.2.2/apache-dolphinscheduler-3.2.2-bin.tar.gz

  # 日志配置
  logging:
    level: INFO
    retention_days: 7
    path: logs

  # 安全配置
  security:
    https_enabled: false
    ssl_cert_path: ""
    ssl_key_path: ""

  # 监控配置
  monitoring:
    prometheus_enabled: true
    prometheus_port: 9090

# ================================================================================
# 配置说明
# ================================================================================
# 1. 版本：DolphinScheduler 3.2.2，推荐使用 Java 11
# 2. 存储：使用 S3 作为资源存储，需要配置 Azure 占位值
# 3. 注册中心：使用外部 EMR 集群提供的 Zookeeper
# 4. 数据库：使用 RDS MySQL，需要提前创建数据库和用户
# 5. 端口变化：Master 5679, Worker 1235（与 3.2.0 不同）
# 6. ⚠️ S3 存储认证问题：
#    - DolphinScheduler 3.2.2 的 IAM Role 支持有已知 bug
#    - 必须使用 access_key_id 和 secret_access_key 进行认证
#    - 不要设置 use_iam_role: true，即使 EC2 有 IAM Role 也不会生效
#    - 建议创建专门的 IAM 用户，只给 S3 相关权限
# 7. 确保安全组允许：
#    - DolphinScheduler 节点之间互通
#    - DolphinScheduler 节点访问 EMR Zookeeper (2181)
#    - DolphinScheduler 节点访问 RDS MySQL (3306)
#    - DolphinScheduler 节点访问 S3 (443)

# ================================================================================
# S3 存储配置重要说明
# ================================================================================
# DolphinScheduler 3.2.2 在 S3 存储方面有以下已知问题：
# 
# 1. IAM Role 支持有 bug：
#    - 即使 EC2 实例配置了正确的 IAM Role
#    - DolphinScheduler 仍然无法正确使用 IAM Role 访问 S3
#    - 会出现权限错误或连接失败
# 
# 2. 必须使用 AK/SK：
#    - 必须在 storage.s3.access_key_id 中配置 AWS Access Key ID
#    - 必须在 storage.s3.secret_access_key 中配置 AWS Secret Access Key
#    - 设置 storage.s3.use_iam_role: false
# 
# 3. 安全建议：
#    - 创建专门的 IAM 用户用于 DolphinScheduler
#    - 只给该用户 S3 相关的最小权限
#    - 定期轮换 Access Key
#    - 不要在代码中硬编码密钥
# 
# 4. 所需 S3 权限：
#    - s3:GetObject
#    - s3:PutObject
#    - s3:DeleteObject
#    - s3:ListBucket
# ================================================================================
